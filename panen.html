<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>Form Panen Sawit - Google Sheets Sync</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* (CSS tetap sama) */
  </style>
</head>
<body class="bg-gray-100 p-2 md:p-4">

<div class="max-w-full mx-auto bg-white rounded-xl shadow-lg p-3 md:p-6">
  <!-- Header Mobile Optimized -->
  <div class="text-center mb-4 md:mb-6">
    <h1 class="text-xl md:text-2xl font-bold text-green-800 mb-1">Form Panen Sawit</h1>
    <p class="text-xs md:text-sm text-gray-600">Sync otomatis ke Google Sheets</p>
  </div>

  <!-- Status Upload Modal -->
  <div id="uploadStatusModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <div id="uploadStatusIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full">
          <!-- Icon akan dimasukkan via JS -->
        </div>
        <h3 id="uploadStatusTitle" class="text-lg leading-6 font-medium text-gray-900 mt-4"></h3>
        <div id="uploadStatusMessage" class="mt-2 px-4 py-3"></div>
        <div class="flex items-center justify-center gap-2 px-4 py-3">
          <button onclick="retryLastUpload()" id="retryButton" class="px-4 py-2 bg-yellow-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-300 hidden">
            üîÑ Coba Lagi
          </button>
          <button id="closeUploadStatus" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
            Tutup
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Koneksi Google Sheets -->
  <div id="connectionStatus" class="mb-4 p-3 rounded-lg hidden">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-gray-300 animate-pulse" id="statusIndicator"></div>
        <span class="text-sm font-medium" id="statusText">Memeriksa koneksi...</span>
      </div>
      <button onclick="showConfigPanel()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
        ‚öôÔ∏è Konfigurasi
      </button>
    </div>
  </div>

  <!-- Panel Konfigurasi -->
  <div id="configPanel" class="hidden mb-4 bg-blue-50 p-4 rounded-lg border border-blue-200">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-blue-800 text-sm md:text-base">Konfigurasi Google Sheets</h3>
      <button onclick="hideConfigPanel()" class="text-gray-500 hover:text-gray-700">‚úï</button>
    </div>
    
    <div class="space-y-3">
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">Web App URL</label>
        <input id="webAppUrl" type="text" placeholder="https://script.google.com/macros/s/..." 
               class="w-full border border-gray-300 p-2 rounded text-sm"
               value="https://script.google.com/macros/s/AKfycbz7lhYCD2Oy5qR_AMa4Rc2GrbwLHa3LVBS5cOOq-J8Nh8rb1trbQJt7ORy2xly-KZrnHA/exec">
        <p class="text-xs text-gray-500 mt-1">
          URL dari Google Apps Script Web App<br>
          <a href="javascript:void(0)" onclick="showSetupGuide()" class="text-blue-600 underline">Lihat panduan setup</a>
        </p>
      </div>
      
      <div class="grid grid-cols-2 gap-2">
        <button onclick="saveConfig()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded text-sm">
          üíæ Simpan
        </button>
        <button onclick="testConnection()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-2 rounded text-sm">
          üîó Test Koneksi
        </button>
      </div>
      
      <div id="configStatus" class="text-xs text-center"></div>
      
      <div class="bg-green-50 p-3 rounded border border-green-200">
        <h4 class="font-bold text-green-800 text-xs mb-1">‚úÖ Konfigurasi Default</h4>
        <p class="text-xs text-gray-700">
          URL Web App sudah diisi otomatis. Klik "Simpan" untuk menggunakan konfigurasi ini.
        </p>
      </div>
    </div>
  </div>

  <!-- Form Input -->
  <!-- (Kode form input tetap sama) -->

  <!-- Tombol Tambah & Sync -->
  <div class="mb-6 md:mb-8 space-y-3">
    <button onclick="tambahData()" id="submitButton" class="w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg font-semibold text-base md:text-lg transition duration-200 flex items-center justify-center gap-2 mobile-btn">
      <span class="text-lg md:text-xl">+</span> <span class="truncate" id="submitText">Tambah ke Daftar</span>
    </button>
    
    <!-- (Tombol lainnya tetap sama) -->
  </div>

  <!-- (Sisanya tetap sama) -->
</div>

<script>
// ============== KONFIGURASI ==============
let dataPanen = [];
let nomorUrut = 1;
let kelompokTerpilih = null;
let lastFailedData = null; // Untuk menyimpan data yang gagal diupload

// Data kelompok (tetap sama)
const dataKelompok = {
  37: { nama: "KHOIRUL HUDA & WELLI SANDRA", kavling: ["872", "862", "908", "851", "852", "855", "853", "854", "856", "857", "858", "859", "860", "861", "863", "874", "873", "871", "870", "869", "868", "867", "866", "865", "864"] },
  38: { nama: "SLAMET & ARI MULYADI", kavling: ["990", "981", "975", "980", "881", "880", "879", "877", "976", "876", "875", "984", "983", "982", "985", "986", "987", "988", "989", "1000", "999", "998", "997", "996"] },
  39: { nama: "NOVI ISWANTO & AHMADI", kavling: ["964", "979", "951", "965", "977", "978", "882", "955", "950", "952", "953", "954", "956", "957", "958", "959", "960", "961", "962", "963", "966", "967", "968", "969"] },
  40: { nama: "SUWAT ACH SUJARWO & HARNIDI", kavling: ["1012", "1011", "1010", "1009", "1008", "1007", "1006", "1013", "1014", "1015", "1016", "1017", "1018", "1019", "1020", "1031", "1032", "1033", "1034", "1035", "1036", "1037", "1038", "1039", "1040", "1041", "1026"] },
  41: { nama: "EKO WAHYUDI S & YUDI ASWAN", kavling: ["1029", "1024", "1001", "1003", "973", "992", "1030", "1028", "1027", "1025", "1023", "1021", "1005", "1004", "972", "971", "970", "991", "993", "994", "995", "1002", "974"] },
  42: { nama: "EDI SUPARNO & SISWO PRANOTO", kavling: ["1065", "1063", "1054", "1053", "1045", "1043", "1042", "1047", "1048", "1049", "1050", "1051", "1052", "1055", "1056", "1057", "1058", "1059", "1060", "1061", "1062", "1064", "1066", "1044", "1046"] },
  43: { nama: "BUDIONO & SUGANDA", kavling: ["1103", "1077", "1075", "1069", "1067", "1068", "1074", "1076", "1078", "1079", "1080", "1081", "1082", "1083", "1084", "1104", "1102", "1101", "1100", "1099", "1098", "1105", "1097", "1070", "1073"] },
  44: { nama: "AGUS SISWANTO & AHMAD SUJA'I", kavling: ["1093", "1089", "1109", "1091", "1133", "1132", "1131", "1096", "1094", "1095", "1092", "1106", "1107", "1108", "1110", "1111", "1112", "1113", "1085", "1086", "1087", "1088", "1072", "1071", "1090"] },
  45: { nama: "DEDI ARDIANSYAH & ELI MULYADI", kavling: ["1150", "1155", "1157", "1137", "1135", "1154", "1134", "1114", "1115", "1116", "1117", "1157", "1156", "1149", "1151", "1152", "1139", "1140", "1141", "1127", "1128", "1129", "1130"] },
  46: { nama: "SUPARDI & MARYANTO", kavling: ["1118", "1124", "1143", "1147", "1163", "1161", "1159", "1119", "1120", "1123", "1125", "1126", "1142", "1144", "1145", "1165", "1166", "1148", "1146", "1164", "1162", "1160", "1158"] },
  47: { nama: "NGATIJO & YUSUF", kavling: ["1193", "1189", "1191", "1182", "1175", "1168", "1170", "1177", "1194", "1179", "1180", "1181", "1183", "1184", "1185", "1186", "1187", "1188", "1192", "1167", "1169", "1174", "1176", "1190"] },
  48: { nama: "RUKITO & GOKLAS M.T", kavling: ["1195", "1200", "1213", "1198", "1212", "1173", "1171", "1172", "1196", "1207", "1206", "1205", "1204", "1203", "1202", "1201", "1210", "1208", "1216", "1215", "1214", "1199"] }
};

// Google Sheets Configuration dengan konfigurasi default
let sheetsConfig = {
  webAppUrl: 'https://script.google.com/macros/s/AKfycbz7lhYCD2Oy5qR_AMa4Rc2GrbwLHa3LVBS5cOOq-J8Nh8rb1trbQJt7ORy2xly-KZrnHA/exec',
  spreadsheetId: '1BrwNg0rPreBFeSqQ-GIlRjvwmYhGutJpWg97S795Ajc'
};

// ============== FUNGSI BANTU ==============
function logDebug(message, data = null) {
  if (console && console.log) {
    console.log(`[DEBUG] ${message}`, data || '');
  }
}

// ============== STATUS UPLOAD FUNCTIONS ==============
function showUploadStatus(success, title, message, showRetry = false) {
  const modal = document.getElementById('uploadStatusModal');
  const icon = document.getElementById('uploadStatusIcon');
  const titleEl = document.getElementById('uploadStatusTitle');
  const messageEl = document.getElementById('uploadStatusMessage');
  const retryButton = document.getElementById('retryButton');
  
  if (success) {
    icon.innerHTML = '<svg class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
    icon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100";
    retryButton.classList.add('hidden');
  } else {
    icon.innerHTML = '<svg class="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
    icon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100";
    
    if (showRetry && lastFailedData) {
      retryButton.classList.remove('hidden');
    } else {
      retryButton.classList.add('hidden');
    }
  }
  
  titleEl.textContent = title;
  messageEl.innerHTML = message;
  
  modal.classList.remove('hidden');
  
  // Auto close setelah 5 detik untuk status sukses
  if (success) {
    setTimeout(() => {
      hideUploadStatus();
    }, 5000);
  }
}

function hideUploadStatus() {
  document.getElementById('uploadStatusModal').classList.add('hidden');
}

function retryLastUpload() {
  if (lastFailedData) {
    hideUploadStatus();
    // Delay kecil sebelum retry
    setTimeout(() => {
      uploadSingleData(lastFailedData);
    }, 500);
  }
}

// ============== KONFIGURASI FUNCTIONS ==============
function showConfigPanel() {
  document.getElementById('configPanel').classList.remove('hidden');
  if (sheetsConfig.webAppUrl) {
    document.getElementById('webAppUrl').value = sheetsConfig.webAppUrl;
  }
}

function hideConfigPanel() {
  document.getElementById('configPanel').classList.add('hidden');
}

function loadConfig() {
  const saved = localStorage.getItem('sheetsConfig');
  if (saved) {
    try {
      sheetsConfig = JSON.parse(saved);
      logDebug('Konfigurasi dimuat:', sheetsConfig);
    } catch (e) {
      logDebug('Error parsing config, using default');
    }
  }
  
  // Selalu gunakan konfigurasi default sebagai fallback
  if (!sheetsConfig.webAppUrl) {
    sheetsConfig.webAppUrl = 'https://script.google.com/macros/s/AKfycbz7lhYCD2Oy5qR_AMa4Rc2GrbwLHa3LVBS5cOOq-J8Nh8rb1trbQJt7ORy2xly-KZrnHA/exec';
  }
  
  if (!sheetsConfig.spreadsheetId) {
    sheetsConfig.spreadsheetId = '1BrwNg0rPreBFeSqQ-GIlRjvwmYhGutJpWg97S795Ajc';
  }
  
  updateConnectionStatus(true);
}

function saveConfig() {
  const webAppUrl = document.getElementById('webAppUrl').value.trim();
  
  if (!webAppUrl) {
    alert('Harap masukkan Web App URL!');
    return;
  }
  
  sheetsConfig = { 
    webAppUrl: webAppUrl,
    spreadsheetId: '1BrwNg0rPreBFeSqQ-GIlRjvwmYhGutJpWg97S795Ajc'
  };
  
  localStorage.setItem('sheetsConfig', JSON.stringify(sheetsConfig));
  
  const configStatus = document.getElementById('configStatus');
  configStatus.textContent = '‚úì Konfigurasi disimpan';
  configStatus.className = "text-xs text-center text-green-600 font-medium";
  
  updateConnectionStatus(true);
  
  setTimeout(() => {
    configStatus.textContent = '';
    hideConfigPanel();
  }, 2000);
}

async function testConnection() {
  const webAppUrl = document.getElementById('webAppUrl').value.trim();
  
  if (!webAppUrl) {
    alert('Harap masukkan Web App URL!');
    return;
  }
  
  const configStatus = document.getElementById('configStatus');
  configStatus.textContent = '‚è≥ Menguji koneksi ke Google Sheets...';
  configStatus.className = "text-xs text-center text-yellow-600 font-medium";
  
  try {
    // Test dengan metode yang lebih sederhana
    const testUrl = webAppUrl + '?test=' + Date.now();
    
    const response = await fetch(testUrl, {
      method: 'GET',
      mode: 'no-cors'
    });
    
    configStatus.textContent = '‚úÖ Koneksi berhasil! Web App aktif.';
    configStatus.className = "text-xs text-center text-green-600 font-medium";
    
    // Simpan URL yang berhasil
    sheetsConfig.webAppUrl = webAppUrl;
    localStorage.setItem('sheetsConfig', JSON.stringify(sheetsConfig));
    
    updateConnectionStatus(true);
    
    showUploadStatus(true, 'Koneksi Berhasil', 
      'Koneksi ke Google Sheets berhasil!<br><br>' +
      `URL: ${webAppUrl.substring(0, 50)}...<br><br>` +
      'Anda sekarang dapat mengupload data panen secara otomatis.');
    
  } catch (error) {
    configStatus.textContent = '‚ùå Gagal terhubung ke Google Sheets';
    configStatus.className = "text-xs text-center text-red-600 font-medium";
    
    showUploadStatus(false, 'Koneksi Gagal', 
      `Gagal terhubung ke Google Sheets.<br><br>
      <strong>Penyebab mungkin:</strong><br>
      1. Web App URL salah<br>
      2. Google Apps Script belum dideploy<br>
      3. Tidak ada koneksi internet<br><br>
      <strong>URL yang dicoba:</strong><br>
      ${webAppUrl}`);
    
    updateConnectionStatus(false);
  }
  
  setTimeout(() => {
    configStatus.textContent = '';
  }, 5000);
}

function updateConnectionStatus(connected) {
  const statusIndicator = document.getElementById('statusIndicator');
  const statusText = document.getElementById('statusText');
  const connectionStatus = document.getElementById('connectionStatus');
  const submitButton = document.getElementById('submitButton');
  const submitText = document.getElementById('submitText');
  
  if (connected && sheetsConfig.webAppUrl) {
    // Status terhubung
    statusIndicator.className = "w-3 h-3 rounded-full bg-green-500 animate-pulse";
    statusText.textContent = '‚úÖ Terhubung ke Google Sheets';
    connectionStatus.className = "mb-4 p-3 rounded-lg bg-green-50 border border-green-200";
    
    // Update tombol submit
    submitButton.className = "w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg font-semibold text-base md:text-lg transition duration-200 flex items-center justify-center gap-2 mobile-btn";
    submitText.textContent = 'Tambah & Sync ke Google Sheets';
    
    connectionStatus.classList.remove('hidden');
  } else {
    // Status tidak terhubung
    statusIndicator.className = "w-3 h-3 rounded-full bg-yellow-500";
    statusText.textContent = '‚ö† Simpan lokal saja (Google Sheets belum dikonfigurasi)';
    connectionStatus.className = "mb-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200";
    
    // Update tombol submit
    submitButton.className = "w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg font-semibold text-base md:text-lg transition duration-200 flex items-center justify-center gap-2 mobile-btn";
    submitText.textContent = 'Tambah ke Daftar (Lokal)';
    
    connectionStatus.classList.remove('hidden');
  }
}

// ============== GOOGLE SHEETS SYNC FUNCTIONS - VERSI DIPERBAIKI ==============
async function uploadSingleData(data) {
  logDebug('Memulai upload data:', data);
  
  if (!sheetsConfig.webAppUrl) {
    return { 
      success: false, 
      message: 'Web App URL tidak dikonfigurasi',
      error: 'CONFIG_MISSING'
    };
  }
  
  try {
    // Format data untuk Google Sheets
    const sheetsData = {
      kelompok: data.kelompok_nomor || '',
      tanggal: data.tanggal || '',
      nama: data.nama || '',
      kavling: data.kavling || '',
      tandan_mentah: data.tandan_mentah || 0,
      tandan_matang: data.tandan_matang || 0,
      tandan_busuk: data.tandan_busuk || 0,
      jangkos: data.jangkos || 0,
      berondolan: data.berondolan || 0,
      timestamp: new Date().toISOString()
    };
    
    logDebug('Data yang akan dikirim:', sheetsData);
    
    // Method 1: Coba dengan fetch biasa (tanpa CORS mode)
    try {
      // Buat URL dengan parameter query untuk menghindari CORS issues
      const url = new URL(sheetsConfig.webAppUrl);
      
      // Tambahkan data sebagai parameter query string
      Object.keys(sheetsData).forEach(key => {
        url.searchParams.append(key, sheetsData[key]);
      });
      
      logDebug('Mengirim request ke:', url.toString());
      
      // Gunakan mode 'no-cors' untuk menghindari CORS
      const response = await fetch(url.toString(), {
        method: 'GET', // Gunakan GET untuk menghindari CORS preflight
        mode: 'no-cors',
        cache: 'no-cache'
      });
      
      logDebug('Response status (no-cors):', 'Tidak bisa membaca karena no-cors');
      
      // Karena mode no-cors, kita tidak bisa membaca response
      // Tapi request sudah dikirim
      return { 
        success: true, 
        message: 'Data berhasil dikirim ke Google Sheets (no-cors mode)'
      };
      
    } catch (fetchError) {
      logDebug('Fetch error, mencoba method 2:', fetchError);
      
      // Method 2: Coba dengan form submission (browser fallback)
      return await tryFormSubmission(sheetsData);
    }
    
  } catch (error) {
    logDebug('Upload error:', error);
    return { 
      success: false, 
      message: `Gagal mengirim ke Google Sheets: ${error.message}`,
      error: error.toString()
    };
  }
}

async function tryFormSubmission(data) {
  return new Promise((resolve) => {
    try {
      // Buat form tersembunyi
      const form = document.createElement('form');
      form.style.display = 'none';
      form.method = 'POST';
      form.action = sheetsConfig.webAppUrl;
      form.target = '_blank'; // Buka di tab baru untuk menghindari CORS
      
      // Tambahkan input untuk setiap data
      Object.keys(data).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = data[key];
        form.appendChild(input);
      });
      
      // Tambahkan form ke body
      document.body.appendChild(form);
      
      // Submit form
      form.submit();
      
      // Hapus form setelah submit
      setTimeout(() => {
        document.body.removeChild(form);
      }, 1000);
      
      resolve({ 
        success: true, 
        message: 'Data dikirim via form submission'
      });
      
    } catch (error) {
      resolve({ 
        success: false, 
        message: `Form submission gagal: ${error.message}`
      });
    }
  });
}

// ============== FUNGSI TAMBAH DATA ==============
async function tambahData() {
  const selectedKavling = document.getElementById('dropdown_kavling').value;
  const manualKavling = document.getElementById('kavling_manual').value.trim();
  const kavlingValue = selectedKavling || manualKavling;
  
  const data = {
    no: nomorUrut,
    kelompok_nomor: kelompokTerpilih,
    kelompok_nama: kelompokTerpilih ? dataKelompok[kelompokTerpilih].nama : '',
    tanggal: document.getElementById('tanggal').value,
    nama: document.getElementById('nama').value.trim(),
    kavling: kavlingValue,
    tandan_mentah: parseInt(document.getElementById('tandan_mentah').value) || 0,
    tandan_matang: parseInt(document.getElementById('tandan_matang').value) || 0,
    tandan_busuk: parseInt(document.getElementById('tandan_busuk').value) || 0,
    jangkos: parseInt(document.getElementById('jangkos').value) || 0,
    berondolan: parseFloat(document.getElementById('berondolan').value) || 0
  };

  if (!validasiInput(data)) return;

  const statusForm = document.getElementById('statusForm');
  
  // Simpan data ke localStorage terlebih dahulu
  dataPanen.push(data);
  nomorUrut++;
  updateTabel();
  resetInput();
  simpanData();
  
  // Simpan data yang gagal untuk retry
  lastFailedData = data;
  
  // Coba upload ke Google Sheets jika terkonfigurasi
  if (sheetsConfig.webAppUrl) {
    statusForm.textContent = '‚è≥ Menyimpan ke Google Sheets...';
    statusForm.className = "text-center text-xs md:text-sm mt-2 text-yellow-600 font-medium";
    
    try {
      const uploadResult = await uploadSingleData(data);
      
      if (uploadResult.success) {
        // Tampilkan status sukses
        showUploadStatus(true, 'Berhasil Upload!', 
          `Data panen berhasil diupload ke Google Sheets.<br><br>
          <strong>Detail Data:</strong><br>
          ‚Ä¢ Kelompok: ${data.kelompok_nomor}<br>
          ‚Ä¢ Nama: ${data.nama}<br>
          ‚Ä¢ Kavling: ${data.kavling}<br>
          ‚Ä¢ T. Mentah: ${data.tandan_mentah}<br>
          ‚Ä¢ T. Matang: ${data.tandan_matang}<br>
          ‚Ä¢ T. Busuk: ${data.tandan_busuk}<br>
          ‚Ä¢ Jangkos: ${data.jangkos}<br>
          ‚Ä¢ Berondolan: ${data.berondolan} kg<br><br>
          <a href="https://docs.google.com/spreadsheets/d/${sheetsConfig.spreadsheetId}" 
             target="_blank" class="text-blue-600 underline">
            Buka Google Sheets
          </a>`);
        
        statusForm.textContent = `‚úÖ Data berhasil disimpan & diupload ke Google Sheets`;
        statusForm.className = "text-center text-xs md:text-sm mt-2 text-green-600 font-medium";
        
      } else {
        // Tampilkan status error
        showUploadStatus(false, 'Upload Gagal', 
          `Data disimpan secara lokal, tetapi gagal upload ke Google Sheets.<br><br>
          <strong>Error:</strong> ${uploadResult.message || uploadResult.error}<br><br>
          <strong>Solusi:</strong><br>
          1. Periksa koneksi internet<br>
          2. Pastikan Web App URL benar<br>
          3. Refresh halaman dan coba lagi`, true);
        
        statusForm.textContent = `‚ö† Data disimpan lokal (Google Sheets: ${uploadResult.message})`;
        statusForm.className = "text-center text-xs md:text-sm mt-2 text-yellow-600 font-medium";
      }
    } catch (error) {
      showUploadStatus(false, 'Upload Error', 
        `Terjadi kesalahan saat mengupload data.<br><br>
        <strong>Error:</strong> ${error.message}<br><br>
        Data tetap tersimpan secara lokal.`, true);
      
      statusForm.textContent = `‚ö† Data disimpan lokal (Error: ${error.message})`;
      statusForm.className = "text-center text-xs md:text-sm mt-2 text-red-600 font-medium";
    }
  } else {
    // Mode lokal saja
    showUploadStatus(true, 'Data Disimpan', 
      `Data berhasil disimpan secara lokal (Total: ${dataPanen.length} data).<br><br>
      <strong>Konfigurasi Google Sheets belum diatur.</strong><br>
      Klik "Konfigurasi" di atas untuk setup upload otomatis.`);
    
    statusForm.textContent = `‚úÖ Data disimpan lokal (Total: ${dataPanen.length})`;
    statusForm.className = "text-center text-xs md:text-sm mt-2 text-green-600 font-medium";
  }
  
  setTimeout(() => {
    statusForm.textContent = '';
  }, 5000);
}

// ============== FUNGSI GOOGLE APPS SCRIPT YANG DIPERBAIKI ==============
const fixedScriptCode = `// Google Apps Script untuk Panen Sawit
// Spreadsheet ID: 1BrwNg0rPreBFeSqQ-GIlRjvwmYhGutJpWg97S795Ajc
// Web App URL: https://script.google.com/macros/s/AKfycbz7lhYCD2Oy5qR_AMa4Rc2GrbwLHa3LVBS5cOOq-J8Nh8rb1trbQJt7ORy2xly-KZrnHA/exec

function doPost(e) {
  try {
    // Buka spreadsheet dengan ID yang sudah ditentukan
    const SPREADSHEET_ID = '1BrwNg0rPreBFeSqQ-GIlRjvwmYhGutJpWg97S795Ajc';
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // Cari atau buat sheet "Data"
    let sheet = spreadsheet.getSheetByName('Data');
    if (!sheet) {
      sheet = spreadsheet.insertSheet('Data');
      // Buat header
      const headers = [
        'Timestamp',
        'Kelompok',
        'Tanggal',
        'Nama Pemanen',
        'Kavling',
        'Tandan Mentah',
        'Tandan Matang',
        'Tandan Busuk',
        'Jangkos',
        'Berondolan (kg)'
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
      sheet.setFrozenRows(1);
    }
    
    // Ambil data dari parameter GET atau POST
    let data = {};
    
    if (e.postData) {
      // Data dari POST (JSON)
      data = JSON.parse(e.postData.contents);
    } else {
      // Data dari GET (query parameters)
      data = e.parameter;
    }
    
    // Siapkan data untuk ditulis
    const timestamp = new Date();
    const rowData = [
      timestamp,
      data.kelompok || data.kelompok_nomor || '',
      data.tanggal || '',
      data.nama || '',
      data.kavling || '',
      Number(data.tandan_mentah) || 0,
      Number(data.tandan_matang) || 0,
      Number(data.tandan_busuk) || 0,
      Number(data.jangkos) || 0,
      Number(data.berondolan) || 0
    ];
    
    // Tambahkan ke sheet
    sheet.appendRow(rowData);
    
    // Return response sukses
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'Data berhasil disimpan',
        timestamp: timestamp.toISOString(),
        row: rowData
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // Return response error
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString(),
        message: 'Gagal menyimpan data'
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  // Untuk GET request, kita panggil doPost juga
  // karena data datang via query parameters
  return doPost(e);
}

// Fungsi untuk mengosongkan data (opsional)
function clearData() {
  const SPREADSHEET_ID = '1BrwNg0rPreBFeSqQ-GIlRjvwmYhGutJpWg97S795Ajc';
  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = spreadsheet.getSheetByName('Data');
  
  if (sheet) {
    // Hapus semua data kecuali header
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.getRange(2, 1, lastRow - 1, 10).clearContent();
    }
  }
  
  return 'Data berhasil dihapus';
}`;

// ============== FUNGSI LAINNYA YANG DIPERLUKAN ==============
function validasiInput(data) {
  if (!data.kelompok_nomor) {
    alert('Pilih kelompok terlebih dahulu!');
    return false;
  }
  
  if (!data.tanggal) {
    alert('Tanggal panen harus diisi!');
    return false;
  }
  
  if (!data.nama) {
    alert('Nama pemanen harus diisi!');
    return false;
  }
  
  if (!data.kavling) {
    alert('Nomor Kavling harus dipilih atau diisi manual!');
    return false;
  }
  
  return true;
}

function updateDataKelompok() {
  const selectedValue = document.getElementById('dropdown_kelompok').value;
  const infoKelompok = document.getElementById('infoKelompok');
  const dropdownKavling = document.getElementById('dropdown_kavling');
  const selectedInfo = document.getElementById('selectedInfo');
  
  dropdownKavling.innerHTML = '<option value="">-- Pilih Kavling --</option>';
  
  if (selectedValue && dataKelompok[selectedValue]) {
    kelompokTerpilih = selectedValue;
    
    infoKelompok.textContent = `Kelompok: ${dataKelompok[selectedValue].nama}`;
    infoKelompok.className = "text-xs md:text-sm text-green-600 font-medium";
    
    dataKelompok[selectedValue].kavling.forEach(kavling => {
      const option = document.createElement('option');
      option.value = kavling;
      option.textContent = kavling;
      dropdownKavling.appendChild(option);
    });
    
    selectedInfo.textContent = `${dataKelompok[selectedValue].kavling.length} kavling tersedia`;
    selectedInfo.className = "text-xs md:text-sm text-gray-600 mt-1";
    
    document.getElementById('tanggal').focus();
  } else {
    kelompokTerpilih = null;
    infoKelompok.textContent = "";
    selectedInfo.textContent = "";
  }
}

function updateTabel() {
  // Fungsi update tabel (sama seperti sebelumnya)
  const tbody = document.getElementById('tabelBody');
  const totalDataEl = document.getElementById('totalData');
  const totalDataMobile = document.getElementById('totalDataMobile');
  
  tbody.innerHTML = '';
  
  if (dataPanen.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="11" class="border border-gray-300 p-4 text-center text-gray-500 text-sm">
          Belum ada data. Tambah data terlebih dahulu.
        </td>
      </tr>
    `;
    
    totalDataEl.textContent = "0 data";
    totalDataMobile.textContent = "0";
    document.getElementById('totalMentahMobile').textContent = "0";
    document.getElementById('totalMatangMobile').textContent = "0";
    document.getElementById('totalBusukMobile').textContent = "0";
    
    return;
  }
  
  let totalMentah = 0;
  let totalMatang = 0;
  let totalBusuk = 0;
  
  dataPanen.forEach((data, index) => {
    totalMentah += data.tandan_mentah;
    totalMatang += data.tandan_matang;
    totalBusuk += data.tandan_busuk;
    
    const row = document.createElement('tr');
    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
    row.innerHTML = `
      <td class="border border-gray-300 p-2 text-center text-xs">${data.no}</td>
      <td class="border border-gray-300 p-2 text-xs truncate max-w-[60px] md:max-w-none" title="${data.kelompok_nama}">${data.kelompok_nomor}</td>
      <td class="border border-gray-300 p-2 text-xs text-center hidden md:table-cell">${formatTanggalSingkat(data.tanggal)}</td>
      <td class="border border-gray-300 p-2 text-xs truncate max-w-[50px]" title="${data.nama}">${data.nama.substring(0, 6)}${data.nama.length > 6 ? '...' : ''}</td>
      <td class="border border-gray-300 p-2 text-xs text-center bg-green-50">${data.kavling}</td>
      <td class="border border-gray-300 p-2 text-xs text-center">${data.tandan_mentah}</td>
      <td class="border border-gray-300 p-2 text-xs text-center hidden sm:table-cell">${data.tandan_matang}</td>
      <td class="border border-gray-300 p-2 text-xs text-center">${data.tandan_busuk}</td>
      <td class="border border-gray-300 p-2 text-xs text-center hidden sm:table-cell">${data.jangkos}</td>
      <td class="border border-gray-300 p-2 text-xs text-center">${data.berondolan.toFixed(1)}</td>
      <td class="border border-gray-300 p-2 text-center">
        <button onclick="hapusData(${index})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">
          ‚ùå
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  totalDataEl.textContent = `${dataPanen.length} data`;
  totalDataMobile.textContent = dataPanen.length;
  document.getElementById('totalMentahMobile').textContent = totalMentah;
  document.getElementById('totalMatangMobile').textContent = totalMatang;
  document.getElementById('totalBusukMobile').textContent = totalBusuk;
}

function formatTanggalSingkat(tanggal) {
  if (!tanggal) return '-';
  const date = new Date(tanggal);
  return date.toLocaleDateString('id-ID', {
    day: '2-digit',
    month: '2-digit'
  });
}

function resetInput() {
  document.getElementById('nama').value = '';
  document.getElementById('tandan_mentah').value = '';
  document.getElementById('tandan_matang').value = '';
  document.getElementById('tandan_busuk').value = '';
  document.getElementById('jangkos').value = '';
  document.getElementById('berondolan').value = '';
  document.getElementById('kavling_manual').value = '';
  
  document.getElementById('dropdown_kavling').selectedIndex = 0;
  document.getElementById('selectedInfo').textContent = kelompokTerpilih ? 
    `${dataKelompok[kelompokTerpilih].kavling.length} kavling tersedia` : "";
  
  document.getElementById('tanggal').focus();
}

function simpanData() {
  const dataSimpan = {
    dataPanen: dataPanen,
    nomorUrut: nomorUrut,
    lastUpdate: new Date().toISOString()
  };
  
  try {
    localStorage.setItem('panenSawitData', JSON.stringify(dataSimpan));
  } catch (error) {
    logDebug('Gagal menyimpan data lokal:', error);
  }
}

function muatData() {
  try {
    const saved = localStorage.getItem('panenSawitData');
    if (saved) {
      const parsed = JSON.parse(saved);
      dataPanen = parsed.dataPanen || [];
      nomorUrut = parsed.nomorUrut || dataPanen.length + 1;
      
      dataPanen.forEach((data, index) => {
        data.no = index + 1;
      });
      
      updateTabel();
    }
  } catch (error) {
    logDebug('Gagal memuat data lokal:', error);
  }
}

// ============== INITIALIZATION ==============
window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tanggal').value = today;
  
  muatData();
  loadConfig();
  
  // Setup event listener untuk modal
  document.getElementById('closeUploadStatus').addEventListener('click', hideUploadStatus);
  
  // Tampilkan status koneksi
  updateConnectionStatus(true);
  
  logDebug('Aplikasi dimuat dengan konfigurasi:', sheetsConfig);
  
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
};

window.addEventListener('resize', () => {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
});
</script>

</body>
</html>