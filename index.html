<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pendataan Panen Sawit</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .table-responsive-mobile {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .mobile-row {
      display: flex;
      flex-direction: column;
      padding: 0.75rem;
      border-bottom: 1px solid #dee2e6;
    }
    
    .mobile-row:nth-child(odd) {
      background-color: rgba(0,0,0,.02);
    }
    
    .mobile-row-header {
      font-weight: 600;
      color: #198754;
      margin-bottom: 0.25rem;
    }
    
    .mobile-row-value {
      margin-bottom: 0.5rem;
    }
    
    .mobile-row-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    @media (max-width: 768px) {
      .desktop-table {
        display: none;
      }
      .mobile-cards {
        display: block;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-cards {
        display: none;
      }
      .desktop-table {
        display: table;
      }
    }
    
    .status-connected {
      color: #198754;
    }
    
    .status-disconnected {
      color: #dc3545;
    }
    
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: #198754;
      z-index: 10;
    }
    
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">
  <h2 class="text-center text-success mb-3">Pendataan Panen Sawit</h2>
  <p>#Input Data Hasil Panen Sesuai dengan Kelompok Masing-Masing.
  <br />#Pastikan saat Melakukan Pengisian Data Panen Sawit untuk Adanya Internet.
  <br />#Form Panen ini bisa input banyak pemanen sekaligus agar cepat saat input Data.</p>

  <!-- Accordion Form -->
  <div class="accordion mb-3" id="accordionPanen"></div>

  <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
    <button class="btn btn-outline-primary" id="addData">
      <i class="bi bi-plus-circle"></i> Tambah Data
    </button>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" id="loadData">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
      <button class="btn btn-success" id="saveData">
        <i class="bi bi-cloud-arrow-up"></i> Simpan
      </button>
    </div>
  </div>

  <!-- Data Table -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center sticky-header">
      <h6 class="mb-0"><i class="bi bi-table me-2"></i>Data Panen</h6>
      <span class="badge bg-light text-success" id="totalData">0 Data</span>
    </div>
    
    <div class="card-body p-0">
      <!-- Desktop Table -->
      <div class="table-responsive-mobile">
        <table class="table table-sm table-hover mb-0 desktop-table" id="tabelPanen">
          <thead class="table-success">
            <tr>
              <th class="text-center">No</th>
              <th>Tanggal</th>
              <th>Pengurus</th>
              <th>Pemanen</th>
              <th>Kavling</th>
              <th class="text-center">Tandan</th>
              <th class="text-center">Berondolan</th>
              <th class="text-center">Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <!-- Mobile Cards -->
      <div class="mobile-cards" id="mobileCards"></div>
    </div>
    
    <div class="card-footer bg-light py-2">
      <div class="row text-center">
        <div class="col-6 col-md-3">
          <small class="text-muted">Total Data:</small>
          <div class="fw-bold text-success" id="summaryTotal">0</div>
        </div>
        <div class="col-6 col-md-3">
          <small class="text-muted">Total Tandan:</small>
          <div class="fw-bold text-primary" id="summaryTandan">0</div>
        </div>
        <div class="col-6 col-md-3">
          <small class="text-muted">Total Berondolan:</small>
          <div class="fw-bold text-warning" id="summaryBerondolan">0</div>
        </div>
        <div class="col-6 col-md-3">
          <small class="text-muted">Update:</small>
          <div class="fw-bold text-info" id="lastUpdate">-</div>
        </div>
      </div>
    </div>
  </div>
    <!-- Connection Status -->
  <div class="alert alert-info d-flex align-items-center justify-content-between" role="alert">
    <div class="d-flex align-items-center">
      <i class="bi bi-google me-2"></i>
      <div>
        <span>Data tersimpan di Online Google</span>
        <small class="d-block" id="connectionStatus">
          <span id="statusText">Memuat...</span>
          <a href="https://docs.google.com/spreadsheets/d/1BC1kS6M4wu3OtPeK3HCjMYvTa8Ro_TrJz_Nfqb-I2as/edit?gid=0#gid=0" 
             target="_blank" class="ms-2">
            <i class="bi bi-link-45deg"></i> Lihat Sheet
          </a>
        </small>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-light text-dark" id="syncStatus">
        <i class="bi bi-cloud-arrow-up"></i> Sync
      </span>
    </div>
  </div>
</div>

<!-- Modal Detail -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Detail Panen</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-2">
            <strong>Tanggal:</strong><br>
            <span id="detailTanggal" class="text-muted">-</span>
          </div>
          <div class="col-md-6 mb-2">
            <strong>Pengurus:</strong><br>
            <span id="detailPengurus" class="text-muted">-</span>
          </div>
          <div class="col-md-6 mb-2">
            <strong>Pemanen:</strong><br>
            <span id="detailPemanen" class="text-muted">-</span>
          </div>
          <div class="col-md-6 mb-2">
            <strong>Kavling:</strong><br>
            <span id="detailKavling" class="text-muted">-</span>
          </div>
        </div>
        
        <hr>
        
        <h6 class="text-success mb-3">Detail Tandan:</h6>
        <div class="row">
          <div class="col-6 mb-2">
            <div class="d-flex justify-content-between">
              <span>Tandan Matang:</span>
              <span id="detailMatang" class="fw-bold">0</span>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="d-flex justify-content-between">
              <span>Tandan Mentah:</span>
              <span id="detailMentah" class="fw-bold">0</span>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="d-flex justify-content-between">
              <span>Tandan Busuk:</span>
              <span id="detailBusuk" class="fw-bold">0</span>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="d-flex justify-content-between">
              <span>Jangkos:</span>
              <span id="detailJangkos" class="fw-bold">0</span>
            </div>
          </div>
        </div>
        
        <div class="alert alert-success mt-3 mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <strong>Total Tandan:</strong>
            <span id="detailTotalTandan" class="fs-5">0</span>
          </div>
        </div>
        
        <div class="alert alert-warning mt-2">
          <div class="d-flex justify-content-between align-items-center">
            <strong>Berondolan:</strong>
            <span id="detailBerondolan" class="fs-5">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ==================== KONFIGURASI ====================
  const GOOGLE_SHEETS_URL = "https://docs.google.com/spreadsheets/d/1BC1kS6M4wu3OtPeK3HCjMYvTa8Ro_TrJz_Nfqb-I2as/edit";
  const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyEpmBkcYm0IwkYrShx931lJjsSdnlocPeQ-N8zgX84kKfxny1CboCTZiPBoXTw9yj2cw/exec";

  // Daftar kelompok dengan kavling khusus masing-masing
  const kelompokKavling = {
    'KLP 37 - Huda & Welly': [
      "851", "852", "853", "854", "855", "856", "857", "858", "859", "860",
      "861", "862", "863", "864", "865", "866", "867", "868", "869", "870",
      "871", "872", "873", "874", "908"
    ],
    'KLP 38 - Slamet & Ari M': [
      "875", "876", "877", "878", "879", "880", "881", "975", "976", "980",
      "981", "982", "983", "984", "985", "986", "987", "988", "989", "990",
      "996", "997", "998", "999", "1000"
    ],
    'KLP 39 - Iis & Ahmadi': [
      "882", "950", "951", "952", "953", "954", "955", "956", "957", "958",
      "959", "960", "961", "962", "963", "964", "965", "966", "967", "968",
      "969", "977", "978", "979", "1040"
    ],
    'KLP 40 - Wahyudi & Aswan': [
      "1006", "1007", "1008", "1009", "1010", "1011", "1012", "1013", "1014", "1015",
      "1016", "1017", "1018", "1019", "1020", "1031", "1032", "1033", "1034", "1035",
      "1036", "1037", "1038", "1039", "1040"
    ],
    'KLP 41 - Suwat & Harnidi': [
      "995", "994", "993", "992", "991", "970", "971", "972", "973", "974",
      "1001", "1002", "1003", "1004", "1005", "1021", "1022", "1023", "1024", "1025",
      "1026", "1027", "1028", "1029", "1030"
    ],
    'KLP 42 - Suparno & Siswo': [
      "1042", "1043", "1044", "1045", "1046", "1047", "1048", "1049", "1050", "1051",
      "1052", "1053", "1054", "1055", "1056", "1057", "1058", "1059", "1060", "1061",
      "1062", "1063", "1064", "1065", "1066"
    ],
    'KLP 43 - Suganda & Budi': [
      "1067", "1068", "1069", "1070", "1073", "1074", "1075", "1076", "1077", "1078",
      "1079", "1080", "1081", "1082", "1083", "1084", "1097", "1098", "1099", "1100",
      "1101", "1102", "1103", "1104", "1105"
    ],
    'KLP 44 - Siswanto & Ahmad': [
      "1071", "1072", "1085", "1086", "1087", "1088", "1089", "1090", "1091", "1092",
      "1093", "1094", "1095", "1096", "1106", "1107", "1108", "1109", "1110", "1111",
      "1112", "1113", "1131", "1132", "1133"
    ],
    'KLP 45 - Dedi & Ely': [
      "1114", "1115", "1116", "1117", "1128", "1127", "1129", "1130", "1134", "1135",
      "1137", "1139", "1140", "1141", "1149", "1150", "1151", "1152", "1154", "1156",
      "1157", "1155", "1166"
    ],
    'KLP 46 - Supardi & Maryanto': [
      "1118", "1119", "1120", "1123", "1124", "1125", "1126", "1142", "1143", "1144",
      "1145", "1146", "1147", "1148", "1158", "1159", "1160", "1161", "1162", "1163",
      "1164", "1165", "1166"
    ],
    'KLP 47 - Yusuf & Ngatijo': [
      "1167", "1168", "1169", "1170", "1174", "1175", "1176", "1177", "1179", "1180",
      "1181", "1182", "1183", "1184", "1185", "1186", "1187", "1188", "1189", "1190",
      "1191", "1192", "1193", "1194"
    ],
    'KLP 48 - Rukito & Goklas': [
      "1171", "1172", "1173", "1195", "1196", "1198", "1199", "1200", "1201", "1202",
      "1203", "1204", "1205", "1206", "1207", "1208", "1210", "1211", "1212", "1213",
      "1214", "1215", "1216"
    ]
  };

  // Daftar kelompok untuk dropdown
  const pengurusList = Object.keys(kelompokKavling);
  
  // ==================== ELEMEN UI ====================
  const accordion = document.getElementById('accordionPanen');
  const tabel = document.getElementById('tabelPanen').querySelector('tbody');
  const mobileCards = document.getElementById('mobileCards');
  const totalDataElement = document.getElementById('totalData');
  const summaryTotal = document.getElementById('summaryTotal');
  const summaryTandan = document.getElementById('summaryTandan');
  const summaryBerondolan = document.getElementById('summaryBerondolan');
  const lastUpdate = document.getElementById('lastUpdate');
  const statusText = document.getElementById('statusText');
  const syncStatus = document.getElementById('syncStatus');
  
  // Data
  let dataPanen = [];
  let detailData = {};
    
  // ==================== FUNGSI UTAMA ====================
  
  function updateStatus(status, message) {
    statusText.textContent = message;
    statusText.className = status === 'connected' ? 'status-connected' : 'status-disconnected';
    
    if (status === 'connected') {
      syncStatus.innerHTML = '<i class="bi bi-cloud-check"></i> Terhubung';
      syncStatus.className = 'badge bg-success text-white';
    } else if (status === 'loading') {
      syncStatus.innerHTML = '<i class="bi bi-arrow-repeat spinner-border-sm"></i> Memuat';
      syncStatus.className = 'badge bg-info text-white';
    } else {
      syncStatus.innerHTML = '<i class="bi bi-cloud-slash"></i> Offline';
      syncStatus.className = 'badge bg-danger text-white';
    }
  }
  
  async function callAppScript(action, data = null) {
    const url = new URL(APP_SCRIPT_URL);
    url.searchParams.append('action', action);
    
    if (data && typeof data === 'object') {
      // Jika data adalah objek, tambahkan sebagai parameter URL
      Object.keys(data).forEach(key => {
        if (data[key] !== undefined && data[key] !== null) {
          url.searchParams.append(key, data[key]);
        }
      });
    }
    
    // Tambah timestamp untuk hindari cache
    url.searchParams.append('_', Date.now());
    
    try {
      const response = await fetch(url.toString());
      const result = await response.json();
      return result;
    } catch (error) {
      throw new Error('Gagal terhubung ke server: ' + error.message);
    }
  }
  
  async function loadData() {
    updateStatus('loading', 'Memuat data...');
    
    try {
      const result = await callAppScript('getData');
      
      if (result.error) {
        updateStatus('disconnected', 'Error: ' + result.error);
        alert('Gagal memuat data: ' + result.error);
        return false;
      }
      
      // Transform data
      dataPanen = result.data.map(item => ({
        id: item.ID,
        tanggal: item.Tanggal,
        pengurus: item.Pengurus,
        pemanen: item.Pemanen,
        kavling: item.Kavling,
        jumlahTandan: parseInt(item.Total_Tandan) || 0,
        berondolan: parseInt(item.Berondolan) || 0
      }));
      
      // Simpan detail data
      detailData = {};
      result.data.forEach(item => {
        detailData[item.ID] = {
          id: item.ID,
          tanggal: item.Tanggal,
          pengurus: item.Pengurus,
          pemanen: item.Pemanen,
          kavling: item.Kavling,
          matang: parseInt(item.Tandan_Matang) || 0,
          mentah: parseInt(item.Tandan_Mentah) || 0,
          busuk: parseInt(item.Tandan_Busuk) || 0,
          jangkos: parseInt(item.Jangkos) || 0,
          jumlahTandan: parseInt(item.Total_Tandan) || 0,
          berondolan: parseInt(item.Berondolan) || 0
        };
      });
      
      // Update tampilan
      updateAllViews();
      updateStatus('connected', `Data dimuat: ${result.count} entri`);
      lastUpdate.textContent = formatTime(new Date());
      
      return true;
      
    } catch (error) {
      updateStatus('disconnected', error.message);
      alert('Gagal memuat data dari Google Sheets: ' + error.message);
      return false;
    }
  }
  
  async function saveData() {
    const forms = accordion.querySelectorAll('.accordion-item');
    if (forms.length === 0) {
      alert('Tidak ada data untuk disimpan');
      return;
    }
    
    // Validasi form - hanya validasi field yang benar-benar required
    let isValid = true;
    let errorMessage = '';
    
    forms.forEach((form, index) => {
      // Validasi hanya untuk field yang benar-benar required
      const requiredFields = form.querySelectorAll('.pengurus[required], .kavling[required], .tanggal[required], .pemanen[required]');
      
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          isValid = false;
          const fieldName = field.previousElementSibling?.textContent || field.getAttribute('placeholder') || 'Field';
          errorMessage = `Form ${index + 1}: ${fieldName} harus diisi!`;
          // Highlight field yang error
          field.classList.add('is-invalid');
        } else {
          field.classList.remove('is-invalid');
        }
      });
    });
    
    if (!isValid) {
      alert(errorMessage);
      return;
    }
    
    updateStatus('loading', 'Menyimpan data...');
    
    const savePromises = [];
    
    forms.forEach(form => {
      const pengurus = form.querySelector('.pengurus').value;
      const tanggal = form.querySelector('.tanggal').value;
      const pemanen = form.querySelector('.pemanen').value;
      const kavling = form.querySelector('.kavling').value;
      
      // Ambil nilai dari input tandan - jika kosong atau tidak valid, gunakan 0
      const matang = parseInt(form.querySelector('.matang').value) || 0;
      const mentah = parseInt(form.querySelector('.mentah').value) || 0;
      const busuk = parseInt(form.querySelector('.busuk').value) || 0;
      const jangkos = parseInt(form.querySelector('.jangkos').value) || 0;
      const berondolan = parseInt(form.querySelector('.berondolan').value) || 0;

      const jumlahTandan = matang + mentah + busuk + jangkos;

      const data = {
        tanggal,
        pengurus,
        pemanen,
        kavling,
        matang,
        mentah,
        busuk,
        jangkos,
        jumlahTandan,
        berondolan
      };
      
      savePromises.push(callAppScript('addData', {data: JSON.stringify(data)}));
    });
    
    try {
      const results = await Promise.all(savePromises);
      
      // Check for errors
      const errors = results.filter(r => r.error);
      if (errors.length > 0) {
        throw new Error(errors.map(e => e.error).join(', '));
      }
      
      // Clear forms
      accordion.innerHTML = '';
      createForm();
      
      // Reload data
      await loadData();
      
      alert(`${results.length} data berhasil disimpan ke Google Sheets!`);
      
    } catch (error) {
      alert('Gagal menyimpan data: ' + error.message);
    }
  }
  
  async function deleteData(id) {
    if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) {
      return;
    }
    
    updateStatus('loading', 'Menghapus data...');
    
    try {
      // PERBAIKAN: Kirim parameter id langsung, bukan dalam objek
      const result = await callAppScript('deleteData', {id: id});
      
      if (result.error) {
        alert('Error: ' + result.error);
      } else {
        // Hapus dari local data
        dataPanen = dataPanen.filter(item => item.id !== id);
        delete detailData[id];
        
        // Update tampilan
        updateAllViews();
        alert('Data berhasil dihapus');
      }
      
    } catch (error) {
      alert('Gagal menghapus data: ' + error.message);
    }
  }
  
  async function clearAllData() {
    if (!confirm('PERINGATAN: Apakah Anda yakin ingin menghapus SEMUA data?\n\nTindakan ini tidak dapat dibatalkan!')) {
      return;
    }
    
    updateStatus('loading', 'Menghapus semua data...');
    
    try {
      const result = await callAppScript('clearData');
      
      if (result.error) {
        alert('Error: ' + result.error);
      } else {
        // Clear local data
        dataPanen = [];
        detailData = {};
        
        // Update tampilan
        updateAllViews();
        alert('Semua data berhasil dihapus');
      }
      
    } catch (error) {
      alert('Gagal menghapus data: ' + error.message);
    }
  }
  
  // ==================== FUNGSI UI ====================
  
  function updateAllViews() {
    updateTable();
    updateMobileCards();
    updateSummary();
  }
  
  function updateTable() {
    tabel.innerHTML = '';
    
    dataPanen.forEach((item, index) => {
      const tr = document.createElement('tr');
      tr.setAttribute('data-id', item.id);
      tr.innerHTML = `
        <td class="text-center align-middle">${index + 1}</td>
        <td class="align-middle">${formatDate(item.tanggal)}</td>
        <td class="align-middle">
          <span class="badge bg-success bg-opacity-10 text-success border border-success">${item.pengurus}</span>
        </td>
        <td class="align-middle">${item.pemanen}</td>
        <td class="align-middle">
          <small>${item.kavling}</small>
        </td>
        <td class="text-center align-middle">
          <span class="badge bg-primary bg-opacity-10 text-primary border border-primary">${item.jumlahTandan}</span>
        </td>
        <td class="text-center align-middle">
          <span class="badge bg-warning bg-opacity-10 text-warning border border-warning">${item.berondolan}</span>
        </td>
        <td class="text-center align-middle">
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-info" onclick="showDetail('${item.id}')" title="Detail">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-outline-danger" onclick="deleteData('${item.id}')" title="Hapus">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      `;
      tabel.appendChild(tr);
    });
  }
  
  function updateMobileCards() {
    mobileCards.innerHTML = '';
    
    if (dataPanen.length === 0) {
      mobileCards.innerHTML = `
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox display-6"></i>
          <p class="mt-2">Belum ada data</p>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadData()">
            <i class="bi bi-download"></i> Muat Data
          </button>
        </div>
      `;
      return;
    }
    
    dataPanen.forEach((item, index) => {
      const card = document.createElement('div');
      card.className = 'mobile-row';
      card.setAttribute('data-id', item.id);
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="mobile-row-header">#${index + 1} - ${formatDate(item.tanggal)}</div>
            <div class="mobile-row-value">
              <span class="badge bg-success bg-opacity-10 text-success border border-success me-1">${item.pengurus}</span>
              <span class="badge bg-info bg-opacity-10 text-info border border-info">${item.kavling}</span>
            </div>
          </div>
          <div class="text-end">
            <div class="badge bg-primary bg-opacity-10 text-primary border border-primary mb-1">${item.jumlahTandan} Tandan</div>
            <div class="badge bg-warning bg-opacity-10 text-warning border border-warning">${item.berondolan} Berondolan</div>
          </div>
        </div>
        <div class="mobile-row-value">
          <strong>Pemanen:</strong> ${item.pemanen}
        </div>
        <div class="mobile-row-actions">
          <button class="btn btn-sm btn-outline-info flex-fill" onclick="showDetail('${item.id}')">
            <i class="bi bi-eye me-1"></i> Detail
          </button>
          <button class="btn btn-sm btn-outline-danger flex-fill" onclick="deleteData('${item.id}')">
            <i class="bi bi-trash me-1"></i> Hapus
          </button>
        </div>
      `;
      mobileCards.appendChild(card);
    });
  }
  
  function updateSummary() {
    const totalData = dataPanen.length;
    const totalTandan = dataPanen.reduce((sum, item) => sum + item.jumlahTandan, 0);
    const totalBerondolan = dataPanen.reduce((sum, item) => sum + item.berondolan, 0);
    
    totalDataElement.textContent = `${totalData} Data`;
    summaryTotal.textContent = totalData;
    summaryTandan.textContent = totalTandan;
    summaryBerondolan.textContent = totalBerondolan;
  }
  
  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    
    return date.toLocaleDateString('id-ID', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  }
  
  function formatTime(date) {
    return date.toLocaleTimeString('id-ID', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  function showDetail(id) {
    const data = detailData[id];
    if (!data) {
      alert('Data tidak ditemukan');
      return;
    }
    
    document.getElementById('detailTanggal').textContent = formatDate(data.tanggal);
    document.getElementById('detailPengurus').textContent = data.pengurus || '-';
    document.getElementById('detailPemanen').textContent = data.pemanen || '-';
    document.getElementById('detailKavling').textContent = data.kavling || '-';
    document.getElementById('detailMatang').textContent = data.matang || 0;
    document.getElementById('detailMentah').textContent = data.mentah || 0;
    document.getElementById('detailBusuk').textContent = data.busuk || 0;
    document.getElementById('detailJangkos').textContent = data.jangkos || 0;
    document.getElementById('detailTotalTandan').textContent = data.jumlahTandan || 0;
    document.getElementById('detailBerondolan').textContent = data.berondolan || 0;
    
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
  }
  
  function createForm() {
    const uniqueId = Date.now() + '-' + Math.floor(Math.random() * 1000);
    const item = document.createElement('div');
    item.className = 'accordion-item';
    item.innerHTML = `
      <h2 class="accordion-header" id="heading${uniqueId}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${uniqueId}">
          <i class="bi bi-plus-circle me-2"></i>
          <span>Data Pemanen: <span id="preview${uniqueId}" class="text-primary">[Klik untuk isi]</span></span>
        </button>
      </h2>
      <div id="collapse${uniqueId}" class="accordion-collapse collapse" data-bs-parent="#accordionPanen">
        <div class="accordion-body">
          <div class="row g-2">
            <div class="col-12">
              <label class="form-label">Nama Pengurus</label>
              <select class="form-select form-select-sm pengurus" required onchange="updateKavlingOptions(this, 'kavling${uniqueId}')">
                <option value="">-- Pilih Pengurus --</option>
                ${pengurusList.map(p => `<option value="${p}">${p}</option>`).join('')}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Nomor Kavling</label>
              <select class="form-select form-select-sm kavling" id="kavling${uniqueId}" required>
                <option value="">-- Pilih Kavling --</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Tanggal Panen</label>
              <input type="date" class="form-control form-control-sm tanggal" required value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Nama Pemanen</label>
              <input type="text" class="form-control form-control-sm pemanen" required 
                oninput="document.getElementById('preview${uniqueId}').textContent=this.value||'[Klik untuk isi]'">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Tandan Matang <small class="text-muted">(optional)</small></label>
              <input type="number" class="form-control form-control-sm matang" min="0" value="0" placeholder="0">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Tandan Mentah <small class="text-muted">(optional)</small></label>
              <input type="number" class="form-control form-control-sm mentah" min="0" value="0" placeholder="0">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Tandan Busuk <small class="text-muted">(optional)</small></label>
              <input type="number" class="form-control form-control-sm busuk" min="0" value="0" placeholder="0">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Tandan Jangkos <small class="text-muted">(optional)</small></label>
              <input type="number" class="form-control form-control-sm jangkos" min="0" value="0" placeholder="0">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Berondolan <small class="text-muted">(optional)</small></label>
              <input type="number" class="form-control form-control-sm berondolan" min="0" value="0" placeholder="0">
            </div>
          </div>
        </div>
      </div>
    `;
    accordion.appendChild(item);
    return uniqueId;
  }
  
  function updateKavlingOptions(selectPengurus, kavlingId) {
    const kavlingSelect = document.getElementById(kavlingId);
    if (!kavlingSelect) return;
    
    kavlingSelect.innerHTML = '<option value="">-- Pilih Kavling --</option>';
    
    if (selectPengurus.value && kelompokKavling[selectPengurus.value]) {
      // Ambil daftar kavling khusus untuk kelompok ini
      const daftarKavling = kelompokKavling[selectPengurus.value];
      
      // Tambahkan setiap kavling sebagai option
      daftarKavling.forEach(kavling => {
        const opt = document.createElement('option');
        opt.value = `${selectPengurus.value} - Kavling ${kavling}`;
        opt.textContent = `Kavling ${kavling}`;
        kavlingSelect.appendChild(opt);
      });
    }
  }
  
  // ==================== EVENT LISTENERS ====================
  
  document.getElementById('addData').addEventListener('click', () => {
    createForm();
  });
  
  document.getElementById('loadData').addEventListener('click', () => {
    loadData();
  });
  
  document.getElementById('saveData').addEventListener('click', () => {
    saveData();
  });
  
  // Tambah tombol hapus semua ke status alert
  const alertDiv = document.querySelector('.alert-info');
  const clearBtn = document.createElement('button');
  clearBtn.className = 'btn btn-sm btn-outline-danger ms-2';
  clearBtn.innerHTML = '<i class="bi bi-trash"></i> Hapus Semua';
  clearBtn.onclick = clearAllData;
  alertDiv.querySelector('.d-flex').appendChild(clearBtn);
  
  // ==================== INISIALISASI ====================
  
  document.addEventListener('DOMContentLoaded', function() {
    // Buat form pertama
    createForm();
    
    // Auto-load data saat halaman dimuat
    setTimeout(() => loadData(), 1000);
  });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
